<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­å¢¨çš„çµæ„Ÿåº“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .title {
            text-align: center;
            margin: 20px 0 30px;
            color: #333;
            font-size: 36px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 50px;
            border-top: 1px solid #eee;
            color: #666;
        }

        .footer p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        /* æ•°æ®ç®¡ç†åŒºåŸŸ */
        .data-management {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .left-buttons {
            display: flex;
            gap: 10px;
        }

        .right-buttons {
            display: flex;
            gap: 10px;
        }

        .delete-all-button {
            background: #d32f2f;
            opacity: 0.7;
            font-size: 12px;
            padding: 6px 12px;
        }

        .delete-all-button:hover {
            background: #b71c1c;
            opacity: 1;
        }

        .management-button {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .management-button:hover {
            background: #1976D2;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
            margin: 0 auto;
            max-width: 600px;
        }

        .upload-area:hover {
            border-color: #2196F3;
            background-color: #f0f8ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #666;
            margin-bottom: 10px;
        }

        /* æ ‡ç­¾åŒºåŸŸ */
        .tag-section {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            position: relative;
            z-index: 1;
        }

        .tag-title {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
            font-weight: bold;
        }

        .tags {
            position: relative;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 2;
        }

        .tag {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
            font-size: 14px;
            position: relative;
            z-index: 3;
        }

        .tag:hover {
            z-index: 999;
        }

        .tag.selected {
            background-color: #2196F3;
            color: white;
            border-color: #1976D2;
        }

        .tag:hover {
            background-color: #f0f8ff;
            border-color: #2196F3;
        }

        /* ç€‘å¸ƒæµåŒºåŸŸ */
        .waterfall-container {
            column-count: 4;
            column-gap: 20px;
            padding: 20px 0;
        }

        .waterfall-item {
            break-inside: avoid;
            margin-bottom: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .waterfall-item:hover {
            transform: scale(1.02);
        }

        .waterfall-item img {
            width: 100%;
            border-radius: 8px;
            display: block;
        }
        /* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal.active .modal-overlay {
            opacity: 1;
        }

        .modal-clickable-area {
            position: absolute;
            top: 0;
            height: 100%;
            width: 35%;
            cursor: pointer;
        }

        .modal-clickable-area.left {
            left: 0;
        }

        .modal-clickable-area.right {
            right: 0;
        }

        .modal-content {
            position: relative;
            width: 90%;
            margin: 30px auto;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s;
            z-index: 1;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-center-area {
            position: absolute;
            top: 0;
            left: 35%;
            width: 30%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .image-info {
            background: white;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: left;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .image-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .delete-button {
            background: #f44336;
        }

        .delete-button:hover {
            background: #d32f2f;
        }

        /* æ ‡ç­¾ç¼–è¾‘æ¨¡æ€æ¡† */
        .edit-modal {
            background: rgba(0,0,0,0.8);
        }

        .edit-content {
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 30px auto;
            border-radius: 8px;
            cursor: default;
        }

        .tag-category {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .tag-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tag-option {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tag-option.selected {
            background-color: #2196F3;
            color: white;
            border-color: #1976D2;
        }

        .tag-option:hover {
            background-color: #f0f8ff;
            border-color: #2196F3;
        }

        .image-notes {
            width: 100%;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
        }

        .save-button {
            display: block;
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .save-button:hover {
            background: #45a049;
        }

        .preview-tag {
            font-size: 12px;
            padding: 2px 8px;
            background: #e3f2fd;
            color: #1976D2;
            border-radius: 12px;
            display: inline-block;
            margin: 2px;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            transition: opacity 0.3s;
        }

        .toast.info {
            background: rgba(33, 150, 243, 0.9);
        }

        .toast.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .toast.success {
            background: rgba(76, 175, 80, 0.9);
        }

        @media (max-width: 1200px) {
            .waterfall-container {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .waterfall-container {
                column-count: 2;
            }
        }

        @media (max-width: 480px) {
            .waterfall-container {
                column-count: 1;
            }
        }

        .ai-features {
            margin: 20px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ai-section {
            text-align: center;
        }

        .ai-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .ai-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .ai-icon {
            font-size: 20px;
        }

        /* AI åˆ†ææ¨¡æ€æ¡†æ ·å¼ */
        .ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .ai-modal-content {
            position: relative;
            width: 90%;
            max-width: 800px;
            margin: 30px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .ai-result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .ai-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .ai-loading:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* è®©æ ‡ç­¾å®¹å™¨å˜æˆå¼¹æ€§æ»šåŠ¨ */
        .tags {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .tags::-webkit-scrollbar {
            width: 6px;
        }

        .tags::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tags::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .tags::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .analysis-sections {
            margin-top: 20px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .analysis-sections.show {
            opacity: 1;
            transform: translateY(0);
        }

        .analysis-sections h4 {
            color: #333;
            margin: 15px 0 10px;
            font-size: 16px;
        }

        .analysis-text {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            line-height: 1.6;
            color: #555;
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 20px;
            background: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }

        /* æ›´æ–°åˆ†æå®¹å™¨çš„æ ·å¼ */
        .analysis-container {
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
            z-index: 1; /* ç¡®ä¿å®¹å™¨åœ¨æ­£ç¡®çš„å±‚çº§ */
            max-width: 1200px;
            margin: 0 auto;
        }

        .analysis-flex {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
            z-index: 2; /* ç¡®ä¿flexå®¹å™¨åœ¨ä¸Šå±‚ */
        }

        .image-section {
            flex: 0 0 45%;
            padding: 15px;
            border-radius: 8px;
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
            z-index: 1;
        }

        .analysis-sections {
            flex: 0 0 55%;
            background: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
            z-index: 3; /* ç¡®ä¿æ–‡å­—å†…å®¹åœ¨æœ€ä¸Šå±‚ */
        }

        .analysis-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
            z-index: 4; /* ç¡®ä¿æ¯ä¸ªåˆ†æé¡¹åœ¨æœ€ä¸Šå±‚ */
        }

        .analysis-item h4 {
            color: #1976D2;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e3f2fd;
        }

        /* ç¡®ä¿æ–‡å­—å¯è§ */
        .analysis-text {
            color: #000000;
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 5px;
            position: relative;
            z-index: 5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .analysis-item:nth-child(1) { animation-delay: 0.1s; }
        .analysis-item:nth-child(2) { animation-delay: 0.2s; }
        .analysis-item:nth-child(3) { animation-delay: 0.3s; }
        .analysis-item:nth-child(4) { animation-delay: 0.4s; }
        .analysis-item:nth-child(5) { animation-delay: 0.5s; }
        .analysis-item:nth-child(6) { animation-delay: 0.6s; }

        /* ä¿®æ”¹AIæ¨¡æ€æ¡†æ ·å¼ */
        .ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .ai-modal-content {
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        /* ç¡®ä¿å›¾ç‰‡ä¸ä¼šè¦†ç›–æ–‡å­— */
        .analysis-img {
            position: relative;
            z-index: 1;
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1024px) {
            .analysis-flex {
                flex-direction: column;
            }

            .image-section,
            .analysis-sections {
                flex: none;
                width: 100%;
            }

            .analysis-sections {
                max-height: none;
            }

            .analysis-img {
                max-height: 400px;
                width: auto;
                margin: 0 auto;
                display: block;
            }
        }

        /* å¢åŠ ä¸€äº›å¯¹æ¯”åº¦ */
        .analysis-container {
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        /* è®©æ–‡å­—æ›´æ¸…æ™° */
        .analysis-text {
            text-shadow: 0 0 1px rgba(0,0,0,0.1);
            font-weight: 500;
        }

        /* æ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼ */
        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }

        /* æ·»åŠ å›¾ç‰‡æ‡’åŠ è½½å ä½æ ·å¼ */
        .waterfall-item {
            position: relative;
            min-height: 100px;
            background: #f5f5f5;
        }

        /* æ·»åŠ æ ‡ç­¾æç¤ºæ ·å¼ */
        .tag-title-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tag-help {
            font-size: 14px;
            color: #999;
            cursor: help;
            position: relative;
        }

        .tag-help:hover::after {
            content: attr(data-tip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            width: max-content;
            max-width: 300px;
            z-index: 1000;
            margin-left: 8px;
        }

        /* æ ‡ç­¾æç¤ºæ ·å¼ */
        .tag[data-tip] {
            position: relative;
        }

        .tag[data-tip]:hover {
            z-index: 9999;
        }

        .tag[data-tip]:hover::after {
            content: attr(data-tip);
            position: absolute;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 12px;
            border-radius: 4px;
            pointer-events: none;
            max-width: 250px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            z-index: 10000;
            left: 50%;
            bottom: 100%;
            margin-bottom: 10px;
        }

        .tag[data-tip]:hover::before {
            content: '';
            position: absolute;
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
            pointer-events: none;
            z-index: 10000;
            left: 50%;
            transform: translateX(-50%);
            bottom: 100%;
            margin-bottom: 5px;
        }

        /* ç¡®ä¿æ ‡ç­¾å®¹å™¨å¯ä»¥æ­£ç¡®æ˜¾ç¤ºæç¤ºæ¡† */
        .tag-section {
            overflow: visible;
            position: relative;
            padding-top: 30px; /* ä¸ºæç¤ºæ¡†é¢„ç•™ç©ºé—´ */
        }

        .tags {
            position: relative;
            z-index: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px; /* ä¸ºæç¤ºæ¡†é¢„ç•™ç©ºé—´ */
        }

        /* é‡å†™æç¤ºæ¡†æ ·å¼ */
        .tooltip-container {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            display: none;
            max-width: 300px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
</head>
<body>
    <div class="container">
        <h1 class="title">å­å¢¨çš„çµæ„Ÿåº“</h1>

        <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
        <div class="data-management">
            <div class="left-buttons">
                <button class="management-button delete-all-button" onclick="confirmDeleteAll()">åˆ é™¤æ‰€æœ‰</button>
            </div>
            <div class="right-buttons">
                <button class="management-button" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <input type="file" id="importInput" accept=".json" hidden>
                <button class="management-button" onclick="document.getElementById('importInput').click()">å¯¼å…¥æ•°æ®</button>
            </div>
        </div>

        <!-- æ·»åŠ  AI åŠŸèƒ½åŒºåŸŸ -->
        <div class="ai-features">
            <div class="ai-section">
                <h2>AI åŠ©æ‰‹</h2>
                <div class="ai-buttons">
                    <button class="ai-button" onclick="showAutoTagging()">
                        <span class="ai-icon">ğŸ·ï¸</span>
                        è‡ªåŠ¨æ ‡ç­¾
                    </button>
                    <button class="ai-button" onclick="showDesignAnalysis()">
                        <span class="ai-icon">ğŸ”</span>
                        è®¾è®¡åˆ†æ
                    </button>
                    <button class="ai-button" onclick="showTrainingArea()">
                        <span class="ai-icon">ğŸ¯</span>
                        æ¨¡å‹è®­ç»ƒ
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="imageInput" accept="image/*" multiple hidden>
                <div class="upload-icon">ğŸ“</div>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p style="color: #666; font-size: 14px;">æ”¯æŒå¤šå¼ å›¾ç‰‡ä¸Šä¼ </p>
            </div>
        </div>

        <!-- æ ‡ç­¾åŒºåŸŸå°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
        <div id="tagContainer"></div>

        <!-- ç€‘å¸ƒæµå›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
        <div class="waterfall-container" id="imageWaterfall"></div>

        <!-- é¡µè„š -->
        <div class="footer">
            <p>åˆ›ä½œè€…ï¼šå­å¢¨</p>
            <p>å¾®ä¿¡å·ï¼šzimo-1376</p>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="imageViewModal">
        <div class="modal-overlay"></div>
        <div class="modal-clickable-area left"></div>
        <div class="modal-center-area">
            <div class="modal-content">
                <img id="modalImage" src="" alt="">
                <div class="image-info">
                    <div id="modalTags"></div>
                    <div id="modalNotes"></div>
                    <div class="image-actions">
                        <button class="action-button delete-button" onclick="deleteCurrentImage()">åˆ é™¤å›¾ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-clickable-area right"></div>
    </div>

    <!-- æ ‡ç­¾ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal edit-modal" id="tagEditModal">
        <div class="edit-content">
            <h3>ç¼–è¾‘å›¾ç‰‡æ ‡ç­¾</h3>
            <img id="editingImage" style="max-width: 100%; max-height: 300px; object-fit: contain; margin: 20px 0;">
            <div class="tag-categories" id="editTagCategories">
                <!-- ç©ºé—´åŠŸèƒ½ -->
                <div class="tag-category">
                    <h4>ç©ºé—´åŠŸèƒ½</h4>
                    <div class="tag-options" data-category="function">
                        <button class="tag-option">å¤§å ‚æ¥å¾…</button>
                        <button class="tag-option">ä¼‘æ¯åŒº</button>
                        <!-- ... å…¶ä»–ç©ºé—´åŠŸèƒ½æ ‡ç­¾ ... -->
                    </div>
                </div>
                <!-- ç©ºé—´æ°›å›´ -->
                <div class="tag-category">
                    <h4>ç©ºé—´æ°›å›´</h4>
                    <div class="tag-options" data-category="atmosphere">
                        <button class="tag-option">æ£®ç³»</button>
                        <button class="tag-option">æµ·ç³»</button>
                        <!-- ... å…¶ä»–ç©ºé—´æ°›å›´æ ‡ç­¾ ... -->
                    </div>
                </div>
                <!-- è®¾è®¡å…ƒç´  -->
                <div class="tag-category">
                    <h4>è®¾è®¡å…ƒç´ </h4>
                    <div class="tag-options" data-category="elements">
                        <button class="tag-option">è½åœ°çª—</button>
                        <button class="tag-option">å¤©çª—</button>
                        <!-- ... å…¶ä»–è®¾è®¡å…ƒç´ æ ‡ç­¾ ... -->
                    </div>
                </div>
                <!-- åœºæ™¯æ•…äº‹ -->
                <div class="tag-category">
                    <h4>åœºæ™¯æ•…äº‹</h4>
                    <div class="tag-options" data-category="story">
                        <button class="tag-option">æ—©é¤æ—¶å…‰</button>
                        <button class="tag-option">ä¸‹åˆèŒ¶</button>
                        <!-- ... å…¶ä»–åœºæ™¯æ•…äº‹æ ‡ç­¾ ... -->
                    </div>
                </div>
            </div>
            <textarea class="image-notes" id="imageNotes" placeholder="æ·»åŠ å¤‡æ³¨..."></textarea>
            <button class="save-button" onclick="saveImageTags()">ä¿å­˜æ ‡ç­¾</button>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>
    <script>
        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
            showToast('å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return false;
        };

        // æ”¹è¿›showToastå‡½æ•°
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`; // æ·»åŠ ä¸åŒç±»å‹çš„æ ·å¼
            toast.style.display = 'block';
            
            // é˜²æ­¢å¤šä¸ªtoasté‡å 
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
            }
            
            window.toastTimeout = setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // åˆå§‹åŒ–æ•°æ®
        let db;
        let currentViewingImage = null;
        const DB_NAME = 'inspirationDB';
        const STORE_NAME = 'images';
        let currentEditingId = null;

        const request = indexedDB.open(DB_NAME, 1);

        request.onerror = (event) => {
            console.error("æ•°æ®åº“é”™è¯¯:", event.target.error);
            showToast("æ•°æ®åº“é”™è¯¯ï¼Œè¯·æ£€æµè§ˆå™¨è®¾ç½®");
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            
            // ä¸Šä¼ åŒºåŸŸäº‹ä»¶å¤„ç†
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            // ç‚¹å‡»ä¸Šä¼ 
            uploadArea.onclick = () => {
                imageInput.click();
            };

            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            imageInput.onchange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    handleFiles(e.target.files);
                    e.target.value = '';  // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
                }
            };

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#2196F3';
            };

            uploadArea.ondragleave = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
            };

            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            };

            // åŠ è½½å·²æœ‰å›¾ç‰‡
            loadImages();
        };

        // å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
        document.getElementById('importInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importData(e.target.files[0]);
            }
        });

        function exportData() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                try {
                    const data = request.result;
                    if (data.length === 0) {
                        showToast('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                        return;
                    }

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inspiration-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("æ•°æ®å¯¼å‡ºæˆåŠŸ");
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            request.onerror = (error) => {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            };
        }

        function importData(file) {
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!Array.isArray(data)) {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    }

                    // éªŒè¯æ¯ä¸ªæ•°æ®é¡¹
                    data.forEach(item => {
                        if (!item.id || !item.url || !item.tags) {
                            throw new Error('æ•°æ®æ ¼å¼ä¸å®Œæ•´');
                        }
                    });

                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    // ä½¿ç”¨Promiseç­‰å¾…æ‰€æœ‰æ•°æ®å¯¼å…¥å®Œæˆ
                    await Promise.all(data.map(item => {
                        return new Promise((resolve, reject) => {
                            const request = store.put(item);
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject();
                        });
                    }));
                    
                    loadImages();
                    showToast(`æˆåŠŸå¯¼å…¥ ${data.length} æ¡æ•°æ®`);
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showToast('å¯¼å…¥å¤±è´¥ï¼š' + (error.message || 'è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'));
                }
            };

            reader.onerror = () => {
                showToast('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };

            reader.readAsText(file);
        }

        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            // ä¿®æ”¹ä¸ºæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        id: Date.now() + Math.random(), // ç¡®ä¿IDå”¯ä¸€
                        url: e.target.result,
                        fileName: file.name,
                        tags: {
                            function: [],
                            atmosphere: [],
                            elements: [],
                            story: []
                        },
                        notes: ''
                    };
                    showEditModal(imageData);
                };
                reader.readAsDataURL(file);
            });
        }

        // å›¾ç‰‡æŸ¥çœ‹ç›¸å…³
        function showImageView(image) {
            currentViewingImage = image;
            const modal = document.getElementById('imageViewModal');
            const modalImage = document.getElementById('modalImage');
            const modalTags = document.getElementById('modalTags');
            const modalNotes = document.getElementById('modalNotes');

            modalImage.src = image.url;
            
            modalTags.innerHTML = `
                <h4>æ ‡ç­¾ï¼š</h4>
                ${Object.entries(image.tags).map(([category, tags]) => `
                    <div class="tag-group">
                        <strong>${getCategoryName(category)}ï¼š</strong>
                        ${tags.map(tag => `<span class="preview-tag">${tag}</span>`).join('')}
                    </div>
                `).join('')}
            `;

            modalNotes.innerHTML = `
                <h4>å¤‡æ³¨ï¼š</h4>
                <p>${image.notes || 'æš‚æ— å¤‡æ³¨'}</p>
            `;

            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeImageView() {
            const modal = document.getElementById('imageViewModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                currentViewingImage = null;
            }, 300);
        }

        // æ ‡ç­¾ç¼–è¾‘ç›¸å…³
        function showEditModal(imageData) {
            currentEditingId = imageData.id;
            const modal = document.getElementById('tagEditModal');
            const editingImage = document.getElementById('editingImage');
            
            editingImage.src = imageData.url;
            document.getElementById('imageNotes').value = imageData.notes || '';
            
            // é‡ç½®æ‰€æœ‰æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tag-option').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            // æ›´æ–°ç¼–è¾‘æ¨¡æ€æ¡†çš„å†…å®¹
            const editContent = document.querySelector('.edit-content .tag-categories');
            let html = '';
            
            Object.entries(tagCategories).forEach(([category, data]) => {
                html += `
                    <div class="tag-category">
                        <h4>${data.title}</h4>
                        <div class="tag-options" data-category="${category}">
                            ${Object.values(data.tags).flat().map(tag => 
                                `<button class="tag-option" onclick="toggleTagSelection(this)">${tag}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            
            editContent.innerHTML = html;
            
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        // æ·»åŠ æ ‡ç­¾é€‰æ‹©åˆ‡æ¢å‡½æ•°
        function toggleTagSelection(tagElement) {
            tagElement.classList.toggle('selected');
        }

        function closeTagEditModal() {
            const modal = document.getElementById('tagEditModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                currentEditingId = null;
            }, 300);
        }

        function saveImageTags() {
            const selectedTags = {};
            
            Object.keys(tagCategories).forEach(category => {
                selectedTags[category] = [];
                document.querySelectorAll(`#editTagCategories .tag-options[data-category="${category}"] .tag-option.selected`).forEach(tag => {
                    selectedTags[category].push(tag.textContent);
                });
            });
            
            const notes = document.getElementById('imageNotes').value;
            
            const imageData = {
                id: currentEditingId,
                url: document.getElementById('editingImage').src,
                tags: selectedTags,
                notes: notes
            };
            
            saveImage(imageData);
            closeTagEditModal();
            showToast("æ ‡ç­¾ä¿å­˜æˆåŠŸ");
        }

        // æ•°æ®åº“æ“ä½œ
        function saveImage(imageData) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(imageData);
            transaction.oncomplete = () => {
                loadImages();
            };
        }

        function deleteCurrentImage() {
            if (!currentViewingImage || !confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.delete(currentViewingImage.id);
            
            transaction.oncomplete = () => {
                closeImageView();
                loadImages();
                showToast("å›¾ç‰‡å·²åˆ é™¤");
            };
        }

        function loadImages() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const images = request.result;
                renderImages(images);
            };
        }

        function renderImages(images) {
            const container = document.getElementById('imageWaterfall');
            container.innerHTML = '';

            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–æ€§èƒ½
            const fragment = document.createDocumentFragment();
            
            images.forEach(image => {
                const div = document.createElement('div');
                div.className = 'waterfall-item';
                
                // æ·»åŠ åŠ è½½åŠ¨ç”»
                div.innerHTML = `
                    <div class="image-loading">åŠ è½½ä¸­...</div>
                    <img src="${image.url}" alt="" loading="lazy">
                `;
                
                const img = div.querySelector('img');
                img.onload = () => {
                    div.querySelector('.image-loading').style.display = 'none';
                };
                
                div.onclick = () => showImageView(image);
                fragment.appendChild(div);
            });
            
            container.appendChild(fragment);
        }

        // å…·å‡½æ•°
        function getCategoryName(category) {
            const names = {
                material: 'æè´¨',
                structure: 'ç»“æ„',
                color: 'è‰²å½©',
                style: 'è®¾è®¡é£æ ¼'
            };
            return names[category] || category;
        }

        // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const category = tag.parentElement.dataset.category;
                const isAll = tag.textContent === 'å…¨éƒ¨';
                const tags = tag.parentElement.querySelectorAll('.tag');
                
                if (isAll) {
                    tags.forEach(t => t.classList.remove('selected'));
                    tag.classList.toggle('selected');
                } else {
                    tag.parentElement.querySelector('.tag:first-child').classList.remove('selected');
                    tag.classList.toggle('selected');
                }
                
                filterImages();
            });
        });

        document.querySelectorAll('.tag-option').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('selected');
            });
        });

        // ç‚¹å·¦å³åŒºåŸŸå…³é—­å›¾ç‰‡
        document.querySelector('.modal-clickable-area.left').addEventListener('click', closeImageView);
        document.querySelector('.modal-clickable-area.right').addEventListener('click', closeImageView);

        // å›¾ç‰‡ç­›é€‰
        function filterImages() {
            const selectedTags = {};
            
            Object.keys(tagCategories).forEach(category => {
                selectedTags[category] = [];
                const tagContainer = document.querySelector(`.tags[data-category="${category}"]`);
                const allTag = tagContainer.querySelector('.tag:first-child');
                
                if (!allTag.classList.contains('selected')) {
                    tagContainer.querySelectorAll('.tag.selected').forEach(tag => {
                        if (tag.textContent !== 'å…¨éƒ¨') {
                            selectedTags[category].push(tag.textContent);
                        }
                    });
                }
            });

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const images = request.result;
                const filteredImages = images.filter(image => {
                    return Object.entries(selectedTags).every(([category, tags]) => {
                        if (tags.length === 0) return true;
                        return tags.some(tag => 
                            image.tags[category] && image.tags[category].includes(tag)
                        );
                    });
                });
                renderImages(filteredImages);
            };
        }

        // åŠ è½½TensorFlow.js
        async function loadAIModels() {
            try {
                const model = await mobilenet.load({
                    version: 2,
                    alpha: 1.0
                });
                showToast('AIæ¨¡å‹åŠ è½½æˆåŠŸ');
                return model;
            } catch (error) {
                console.error('AIæ¨¡å‹åŠ è½½å¤±è´¥:', error);
                showToast('AIæ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return null;
            }
        }

        // è‡ªåŠ¨æ ‡ç­¾åŠŸèƒ½
        function showAutoTagging() {
            const modal = document.createElement('div');
            modal.className = 'ai-modal';
            modal.innerHTML = `
                <div class="ai-modal-content">
                    <h3>AI è‡ªåŠ¨æ ‡ç­¾</h3>
                    <div class="upload-area" id="aiUploadArea">
                        <input type="file" id="aiImageInput" accept="image/*" hidden>
                        <div class="upload-icon">ğŸ¤–</div>
                        <p>ä¸Šä¼ å›¾ç‰‡è¿›è¡Œè‡ªåŠ¨æ ‡ç­¾åˆ†æ</p>
                    </div>
                    <div class="ai-result" id="aiTagResult"></div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // å¤„ç†ä¸Šä¼ é€»è¾‘
            const aiUploadArea = document.getElementById('aiUploadArea');
            const aiImageInput = document.getElementById('aiImageInput');
            
            aiUploadArea.onclick = () => aiImageInput.click();
            aiImageInput.onchange = handleAIImageUpload;
        }

        // è®¾è®¡åˆ†æåŠŸèƒ½
        async function showDesignAnalysis() {
            const modal = document.createElement('div');
            modal.className = 'ai-modal';
            modal.innerHTML = `
                <div class="ai-modal-content">
                    <h3>è®¾è®¡åˆ†æ</h3>
                    <div class="upload-area" id="designUploadArea">
                        <input type="file" id="designImageInput" accept="image/*" hidden>
                        <div class="upload-icon">ğŸ“Š</div>
                        <p>ä¸Šä¼ æ•ˆæœå›¾è·å–è®¾è®¡å»ºè®®</p>
                    </div>
                    <div class="ai-result" id="designAnalysisResult"></div>
                    <button class="action-button" onclick="closeAIModal()" style="margin-top: 20px;">å…³é—­</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';

            // å¤„ç†ä¼ é€»è¾‘
            const designUploadArea = document.getElementById('designUploadArea');
            const designImageInput = document.getElementById('designImageInput');
            
            designUploadArea.onclick = () => designImageInput.click();
            designImageInput.onchange = handleDesignImageUpload;
        }

        // ä¿®æ”¹å¤„ç†è®¾è®¡å›¾ç‰‡ä¸Šä¼ å‡½æ•°
        async function handleDesignImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const analysisResult = document.getElementById('designAnalysisResult');
            analysisResult.innerHTML = '<div class="ai-loading">æ­£åœ¨åˆ†æè®¾è®¡...</div>';

            try {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageUrl = e.target.result;
                    img.src = imageUrl;
                    
                    img.onload = async () => {
                        try {
                            // ä½¿ç”¨MobileNetæ¨¡å‹åˆ†æå›¾ç‰‡
                            const model = await mobilenet.load();
                            const predictions = await model.classify(img, 10);
                            console.log('å›¾ç‰‡è¯†åˆ«ç»“æœ:', predictions);

                            // åˆ†æå›¾ç‰‡é¢œè‰²
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const colorAnalysis = analyzeImageColors(imageData.data);

                            // æ ¹æ®è¯†åˆ«ç»“æœç”Ÿæˆåˆ†æå†…å®¹
                            const analysis = {
                                concept: generateConceptAnalysis(predictions),
                                space: generateSpaceAnalysis(predictions),
                                elements: generateElementsAnalysis(predictions),
                                materials: generateMaterialsAnalysis(predictions, colorAnalysis),
                                colors: generateColorAnalysis(colorAnalysis),
                                cultural: generateCulturalAnalysis(predictions)
                            };

                            // ä¿®æ”¹æ˜¾ç¤ºåˆ†æç»“æœçš„HTML
                            const resultHTML = `
                                <div style="display: flex; gap: 30px; padding: 20px; background: white; border-radius: 8px;">
                                    <div style="flex: 0 0 45%;">
                                        <img src="${imageUrl}" alt="è®¾è®¡å›¾" style="width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    </div>
                                    <div style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                        <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <h4 style="color: #000; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">ğŸ¨ è®¾è®¡ç†å¿µ</h4>
                                            <div style="color: #000; line-height: 1.6;">${analysis.concept}</div>
                                        </div>
                                        <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <h4 style="color: #000; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">ğŸ“ ç©ºé—´å¸ƒå±€</h4>
                                            <div style="color: #000; line-height: 1.6;">${analysis.space}</div>
                                        </div>
                                        <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <h4 style="color: #000; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">âœ¨ è®¾è®¡å…ƒç´ </h4>
                                            <div style="color: #000; line-height: 1.6;">${analysis.elements}</div>
                                        </div>
                                        <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <h4 style="color: #000; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">ğŸ­ æè´¨æ­é…</h4>
                                            <div style="color: #000; line-height: 1.6;">${analysis.materials}</div>
                                        </div>
                                        <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <h4 style="color: #000; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">ğŸŒˆ è‰²å½©æ–¹æ¡ˆ</h4>
                                            <div style="color: #000; line-height: 1.6;">${analysis.colors}</div>
                                        </div>
                                        <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <h4 style="color: #000; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">ğŸ›ï¸ æ–‡åŒ–å†…æ¶µ</h4>
                                            <div style="color: #000; line-height: 1.6;">${analysis.cultural}</div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            analysisResult.innerHTML = resultHTML;
                        } catch (error) {
                            console.error('åˆ†æè¿‡ç¨‹å‡ºé”™:', error);
                            analysisResult.innerHTML = '<div class="error">åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                        }
                    };
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                analysisResult.innerHTML = '<div class="error">æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // åˆ†æç‰‡é¢œè‰²
        function analyzeImageColors(imageData) {
            let colors = {
                warm: 0,
                cool: 0,
                neutral: 0,
                bright: 0,
                dark: 0
            };

            for (let i = 0; i < imageData.length; i += 4) {
                const r = imageData[i];
                const g = imageData[i + 1];
                const b = imageData[i + 2];

                // åˆ†æè‰²æ¸©
                if (r > g && r > b) colors.warm++;
                else if (b > r && b > g) colors.cool++;
                else colors.neutral++;

                // åˆ†ææ˜åº¦
                const brightness = (r + g + b) / 3;
                if (brightness > 128) colors.bright++;
                else colors.dark++;
            }

            return colors;
        }

        // ç”Ÿæˆè®¾è®¡ç†å¿µåˆ†æ
        function generateConceptAnalysis(predictions) {
            const mainElements = predictions.slice(0, 3).map(p => p.className);
            const style = predictions.find(p => 
                p.className.toLowerCase().includes('modern') || 
                p.className.toLowerCase().includes('traditional')
            );

            return `è¿™æ˜¯ä¸€ä¸ªä»¥${style ? style.className : 'ç°ä»£'}é£æ ¼ä¸ºä¸»çš„ç©ºé—´è®¾è®¡ã€‚ç©ºé—´ä¸­çªå‡ºçš„${
                mainElements.join('ã€')}ç­‰å…ƒç´ ç°äº†è®¾è®¡å¸ˆå¯¹ç©ºé—´åŠŸèƒ½ä¸ç¾æ„Ÿçš„æ·±å…¥æ€è€ƒã€‚è®¾è®¡ç†å¿µæ³¨é‡ç©ºé—´çš„å®ç”¨æ€§ä¸ç¾æ„Ÿçš„å¹³è¡¡ï¼Œ
                é€šè¿‡ç²¾å¿ƒé€‰æ‹©çš„å…ƒç´ ç»„åˆï¼Œæ‰“é€ å‡ºæ—¢èˆ’é€‚åˆå¯Œæœ‰å“ä½çš„ç”Ÿæ´»ç¯å¢ƒã€‚`;
        }

        // ç”Ÿæˆç©ºé—´å¸ƒå±€åˆ†æ
        function generateSpaceAnalysis(predictions) {
            const hasOpenSpace = predictions.some(p => 
                p.className.toLowerCase().includes('room') || 
                p.className.toLowerCase().includes('space')
            );
            const hasWindow = predictions.some(p => 
                p.className.toLowerCase().includes('window')
            );

            return `ç©ºé—´é‡‡ç”¨${hasOpenSpace ? 'å¼€æ”¾å¼' : 'åŠŸèƒ½åˆ†åŒºå¼'}å¸ƒå±€ï¼Œçº¿è§„åˆ’æµç•…è‡ªç„¶ã€‚${
                hasWindow ? 'å……è¶³çš„è‡ªç„¶é‡‡å…‰æå‡äº†ç©ºé—´çš„é€šé€æ„Ÿï¼Œ' : ''}ç©ºé—´å±‚æ¬¡åˆ†æ˜ï¼ŒåŠŸèƒ½åŒºåŸŸåˆ’åˆ†åˆç†ï¼Œ
                æ—¢ä¿è¯äº†å„åŒºåŸŸçš„ç‹¬ç«‹æ€§ï¼Œåˆè®©æ•´ä½“ç©ºé—´ä¿æŒè‰¯å¥½çš„äº’åŠ¨æ€§ã€‚`;
        }

        // ç”Ÿæˆè®¾è®¡å…ƒç´ åˆ†æ
        function generateElementsAnalysis(predictions) {
            const elements = predictions.map(p => ({
                name: p.className,
                probability: p.probability
            })).filter(e => e.probability > 0.1);

            // åˆ†ç±»å…ƒç´ 
            const furniture = elements.filter(e => 
                e.name.toLowerCase().includes('chair') || 
                e.name.toLowerCase().includes('table') || 
                e.name.toLowerCase().includes('sofa') ||
                e.name.toLowerCase().includes('bed')
            );
            
            const lighting = elements.filter(e => 
                e.name.toLowerCase().includes('lamp') || 
                e.name.toLowerCase().includes('light')
            );
            
            const decor = elements.filter(e => 
                e.name.toLowerCase().includes('art') || 
                e.name.toLowerCase().includes('plant') ||
                e.name.toLowerCase().includes('vase')
            );

            return `ç©ºé—´ä¸­ä¸»è¦åŒ…å«äº†${furniture.length > 0 ? 'å®¶å…·ï¼ˆ' + furniture.map(f => f.name).join('ã€') + 'ï¼‰ã€' : ''}
                ${lighting.length > 0 ? 'ç…§æ˜ï¼ˆ' + lighting.map(l => l.name).join('ã€') + 'ï¼‰ã€' : ''}
                ${decor.length > 0 ? 'è£…é¥°ï¼ˆ' + decor.map(d => d.name).join('ã€') + 'ï¼‰' : ''}ç­‰è®¾è®¡å…ƒç´ ã€‚
                è¿™äº›å…ƒç´ çš„ç»„åˆè¥é€ å‡ºå±‚æ¬¡ä¸°å¯Œçš„ç©ºé—´æ•ˆæœï¼Œæ¯ä¸ªå…ƒç´ éƒ½ç»è¿‡ç²¾å¿ƒå¸ƒç½®ï¼Œå…±åŒæ„å»ºå‡ºå’Œè°ç»Ÿä¸€çš„è®¾è®¡è¯­è¨€ã€‚`;
        }

        // ç”Ÿæˆæè´¨åˆ†æ
        function generateMaterialsAnalysis(predictions, colorAnalysis) {
            const materials = predictions.filter(p => p.probability > 0.15)
                .map(p => p.className.toLowerCase());
            
            let materialTypes = [];
            if (materials.some(m => m.includes('wood') || m.includes('timber'))) {
                materialTypes.push('æœ¨è´¨');
            }
            if (materials.some(m => m.includes('metal') || m.includes('steel'))) {
                materialTypes.push('é‡‘å±');
            }
            if (materials.some(m => m.includes('fabric') || m.includes('textile'))) {
                materialTypes.push('å¸ƒè‰º');
            }
            if (materials.some(m => m.includes('glass'))) {
                materialTypes.push('ç»ç’ƒ');
            }
            if (materials.some(m => m.includes('stone') || m.includes('marble'))) {
                materialTypes.push('çŸ³æ');
            }

            if (materialTypes.length === 0) {
                materialTypes = ['ç°ä»£æ··åˆæè´¨'];
            }

            return `ç©ºé—´è¿ç”¨äº†${materialTypes.join('ã€')}ç­‰æè´¨ï¼Œæè´¨æ­é…è‡ªç„¶å’Œè°ã€‚
                ${colorAnalysis.warm > colorAnalysis.cool ? 'æ¸©æ¶¦çš„æè´¨è´¨æ„Ÿ' : 'æ¸…çˆ½çš„æè´¨è´¨æ„Ÿ'}
                ä¸ºç©ºé—´å¢æ·»äº†ç‹¬ç‰¹çš„è§¦æ„Ÿä½“éªŒï¼Œä¸åŒæè´¨ä¹‹é—´è¿‡æ¸¡è‡ªç„¶ï¼Œç›¸äº’å‘¼ï¿½ï¿½ï¿½ï¼Œåˆ›é€ å‡ºï¿½ï¿½å¯Œçš„è´¨æ„Ÿå±‚æ¬¡ã€‚`;
        }

        // ç”Ÿæˆè‰²å½©åˆ†æ
        function generateColorAnalysis(colorAnalysis) {
            const total = colorAnalysis.warm + colorAnalysis.cool + colorAnalysis.neutral;
            const warmPercent = (colorAnalysis.warm / total * 100).toFixed(0);
            const coolPercent = (colorAnalysis.cool / total * 100).toFixed(0);
            const brightPercent = (colorAnalysis.bright / total * 100).toFixed(0);

            let colorScheme = '';
            if (colorAnalysis.warm > colorAnalysis.cool) {
                colorScheme = `ä»¥æ¸©æš–è‰²ä¸ºä¸»(çº¦å ${warmPercent}%)ï¼Œè¥é€ å‡ºæ¸©é¦¨èˆ’é€‚çš„æ°›å›´`;
            } else if (colorAnalysis.cool > colorAnalysis.warm) {
                colorScheme = `ä»¥å†·é™è‰²è°ƒä¸ºä¸»(çº¦å ${coolPercent}%)ï¼Œæ‰“é€ æ¸…æ–°æ€¡äººçš„ç©ºé—´æ„Ÿ`;
            } else {
                colorScheme = 'é‡‡ç”¨ä¸­æ€§è‰²è°ƒä¸ºä¸»ï¼Œå‘ˆç°å‡ºæ²‰ç¨³å¤§æ°”çš„æ ¼è°ƒ';
            }

            return `ç©ºé—´è‰²å½©æ–¹æ¡ˆ${colorScheme}ã€‚${
                brightPercent > 60 ? 'æ˜äº®çš„è‰²è°ƒ(çº¦å ' + brightPercent + '%)æå‡äº†ç©ºé—´çš„é€šé€æ„Ÿï¼Œ' : 
                'æ·±æ²‰çš„è‰²è°ƒè¥é€ å‡ºé™è°§çš„æ°›å›´ï¼Œ'
            }é€šè¿‡ä¸»è‰²è°ƒä¸ç‚¹ç¼€è‰²å·§å¦™é…åˆï¼Œå½¢æˆå±‚æ¬¡ä¸°å¯Œçš„è§†è§‰æ•ˆæœï¼Œä½¿ç©ºé—´æ—¢ç»Ÿä¸€å’Œè°åˆå¯Œæœ‰å˜åŒ–ã€‚`;
        }

        // ä¿®æ”¹ handleAIImageUpload å‡½æ•°
        async function handleAIImageUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡');
                return;
            }

            const resultDiv = document.getElementById('aiTagResult');
            resultDiv.innerHTML = '<div class="ai-loading">æ­£åœ¨åˆ†æå›¾ç‰‡...</div>';
            
            try {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    img.src = e.target.result;
                    img.onload = async () => {
                        try {
                            // åŠ è½½æ¨¡å‹
                            const model = await mobilenet.load({
                                version: 2,
                                alpha: 1.0
                            });

                            // è·å–é¢„æµ‹ç»“æœ
                            const predictions = await model.classify(img, 10);
                            console.log('é¢„æµ‹ç»“æœ:', predictions);

                            // æ ¹æ®é¢„æµ‹ç»“æœç”Ÿæˆæ ‡ç­¾å»ºè®®
                            const suggestedTags = {
                                function: analyzeFunctionTags(predictions),
                                atmosphere: analyzeAtmosphereTags(predictions),
                                elements: analyzeElementTags(predictions),
                                story: analyzeStoryTags(predictions)
                            };

                            // æ˜¾ç¤ºç»“æœ
                            displayResults(resultDiv, img, suggestedTags);
                            
                        } catch (error) {
                            console.error('åˆ†æå¤±è´¥:', error);
                            resultDiv.innerHTML = '<div class="error">åˆ†æå¤±è´¥: ' + error.message + '</div>';
                        }
                    };
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                resultDiv.innerHTML = '<div class="error">æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // æ·»åŠ æ–°çš„åˆ†æå‡½æ•°
        function analyzeFunctionTags(predictions) {
            const functionKeywords = {
                'room': ['æ ‡å‡†å®¢æˆ¿', 'å¥—æˆ¿'],
                'dining': ['é¤å…', 'å…¬å…±å¨æˆ¿'],
                'living': ['ä¼‘æ¯åŒº', 'é˜…è¯»åŒº'],
                'gym': ['å¥èº«åŒº', 'ç‘œä¼½å®¤'],
                'outdoor': ['åº­é™¢', 'éœ²å°', 'é˜³å°'],
                'pool': ['æ³³æ± '],
                'workspace': ['Co-working']
            };
            
            const tags = new Set();
            predictions.forEach(pred => {
                const label = pred.className.toLowerCase();
                Object.entries(functionKeywords).forEach(([key, values]) => {
                    if (label.includes(key) && pred.probability > 0.15) {
                        values.forEach(tag => tags.add(tag));
                    }
                });
            });
            
            return Array.from(tags);
        }
        
        function analyzeAtmosphereTags(predictions) {
            const atmosphereKeywords = {
                'nature': ['æ£®ç³»', 'ç”°å›­ç³»'],
                'water': ['æµ·ç³»'],
                'mountain': ['å±±ç³»'],
                'zen': ['ç¦…æ„'],
                'art': ['è‰ºæœ¯'],
                'vintage': ['å¤å¤'],
                'bright': ['æ™¨å…‰', 'æ—¥å…‰'],
                'sunset': ['é»„æ˜'],
                'night': ['å¤œæ™š']
            };
            
            const tags = new Set();
            predictions.forEach(pred => {
                const label = pred.className.toLowerCase();
                Object.entries(atmosphereKeywords).forEach(([key, values]) => {
                    if (label.includes(key) && pred.probability > 0.15) {
                        values.forEach(tag => tags.add(tag));
                    }
                });
            });
            
            return Array.from(tags);
        }
        
        function analyzeElementTags(predictions) {
            const elementKeywords = {
                'window': ['è½åœ°çª—', 'å¤©çª—'],
                'arch': ['æ‹±é—¨'],
                'ceiling': ['åŠé¡¶'],
                'stairs': ['æ¥¼æ¢¯'],
                'fireplace': ['å£ç‚‰'],
                'courtyard': ['å†…å¤©äº•'],
                'curtain': ['çª—å¸˜'],
                'carpet': ['åœ°æ¯¯'],
                'cushion': ['æŠ±æ•'],
                'bed': ['åºŠå“'],
                'art': ['è‰ºæœ¯å“'],
                'plant': ['ç»¿æ¤'],
                'lamp': ['ç¯å…·'],
                'furniture': ['å®¶å…·']
            };
            
            const tags = new Set();
            predictions.forEach(pred => {
                const label = pred.className.toLowerCase();
                Object.entries(elementKeywords).forEach(([key, values]) => {
                    if (label.includes(key) && pred.probability > 0.15) {
                        values.forEach(tag => tags.add(tag));
                    }
                });
            });
            
            return Array.from(tags);
        }
        
        function analyzeStoryTags(predictions) {
            const storyKeywords = {
                'dining': ['æ—©é¤æ—¶å…‰'],
                'cafe': ['ä¸‹åˆèŒ¶'],
                'camping': ['éœ²è¥'],
                'party': ['æ´¾å¯¹'],
                'yoga': ['ç‘œä¼½å†¥æƒ³'],
                'work': ['å·¥ä½œ'],
                'reading': ['é˜…è¯»'],
                'sea': ['æµ·æ™¯ç¬¬ä¸€æ’'],
                'mountain': ['å±±æ™¯ç¬¬ä¸€æ’'],
                'forest': ['æ£®æ—ç¯ç»•'],
                'city': ['åŸå¸‚å¤©é™…çº¿']
            };
            
            const tags = new Set();
            predictions.forEach(pred => {
                const label = pred.className.toLowerCase();
                Object.entries(storyKeywords).forEach(([key, values]) => {
                    if (label.includes(key) && pred.probability > 0.15) {
                        values.forEach(tag => tags.add(tag));
                    }
                });
            });
            
            return Array.from(tags);
        }

        // æ·»åŠ å…³é—­AIæ¨¡æ€æ¡†çš„å‡½æ•°
        function closeAIModal() {
            const modal = document.querySelector('.ai-modal');
            if (modal) {
                modal.remove();
            }
        }

        // ä¿®æ”¹ displayResults å‡½æ•°
        function displayResults(resultDiv, img, suggestedTags) {
            resultDiv.innerHTML = `
                <div class="tag-preview">
                    <div class="preview-image" style="margin-bottom: 20px; text-align: center;">
                        <img src="${img.src}" alt="é¢„è§ˆå›¾ç‰‡" style="max-width: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    </div>
                    <h4>AI å»ºè®®æ ‡ç­¾ï¼ˆAIå»ºè®®æ ‡ç­¾è‡ªåŠ¨é€‰ä¸­ï¼Œå¯ä»¥ç»§ç»­é€‰æ‹©å…¶ä»–æ ‡ç­¾ï¼‰ï¼š</h4>
                    <div class="tag-categories">
                        ${Object.entries(tagCategories).map(([category, data]) => `
                            <div class="tag-category">
                                <strong>${data.title}ï¼š</strong>
                                <div class="tag-options" data-category="${category}">
                                    ${Object.values(data.tags).flat().map(tag => `
                                        <button class="tag-option ${suggestedTags[category].includes(tag) ? 'selected' : ''}">${tag}</button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <textarea class="image-notes" id="aiImageNotes" placeholder="æ·»åŠ å¤‡æ³¨..."></textarea>
                    <button class="save-button" onclick="saveAITags()" style="margin-top: 20px; width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">ç¡®è®¤æ ‡ç­¾</button>
                </div>
            `;

            // æ·»åŠ æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            resultDiv.querySelectorAll('.tag-option').forEach(tag => {
                tag.addEventListener('click', () => {
                    tag.classList.toggle('selected');
                });
            });
        }

        // æ·»åŠ å¤šä¸ªæ¨¡å‹åŠ è½½
        async function loadImageModels() {
            const models = {
                mobilenet: await mobilenet.load(),
                efficientnet: await tf.loadGraphModel('path_to_efficientnet'),
                resnet: await tf.loadGraphModel('path_to_resnet')
            };
            return models;
        }

        // ç»„åˆå¤šä¸ªæ¨¡å‹çš„é¢„æµ‹ç»“æœ
        async function combineModelPredictions(img, models) {
            const predictions = await Promise.all([
                models.mobilenet.classify(img),
                models.efficientnet.predict(img),
                models.resnet.predict(img)
            ]);
            
            return mergePredictions(predictions);
        }

        // åˆå¹¶é¢„æµ‹ç»“æœ
        function mergePredictions(predictions) {
            // å®ç°é¢„æµ‹ç»“æœåˆå¹¶é€»è¾‘
            return predictions[0]; // ä¸´æ—¶è¿”å€¼
        }

        // æ·»åŠ ç®€å•çš„å­¦ä¹ å‹æ¨¡å‹
        class LearningModel {
            constructor() {
                this.patterns = [];
            }

            // æ·»åŠ æ–°çš„å­¦ä¹ æ ·æœ¬
            addPattern(features, tags) {
                this.patterns.push({ features, tags });
            }

            // æ ¹æ®ç‰¹å¾é¢„æµ‹æ ‡ç­¾
            predict(features) {
                if (this.patterns.length === 0) return null;

                // æ‰¾åˆ°æœ€ç›¸ä¼¼çš„æ ·æœ¬
                const similarPattern = this.patterns.reduce((best, current) => {
                    const currentSimilarity = this.calculateSimilarity(features, current.features);
                    const bestSimilarity = this.calculateSimilarity(features, best.features);
                    return currentSimilarity > bestSimilarity ? current : best;
                });

                return similarPattern.tags;
            }

            // è®¡ç®—ç‰¹å¾ç›¸ä¼¼åº¦
            calculateSimilarity(features1, features2) {
                // å®ç°ç‰¹å¾ç›¸ä¼¼åº¦è®¡ç®—
                return 0.5; // ä¸´æ—¶è¿”å›å€¼
            }
        }

        // åˆ›å»ºå­¦ä¹ å‹æ¨¡å‹å®ä¾‹
        const learningModel = new LearningModel();

        // åœ¨ä¿å­˜æ ‡ç­¾æ—¶æ›´æ–°å­¦ä¹ æ¨¡å‹
        function updateLearningModel(imageFeatures, finalTags) {
            learningModel.addPattern(imageFeatures, finalTags);
        }

        // æ·»åŠ  saveAITags å‡½æ•°
        async function saveAITags() {
            const aiImageInput = document.getElementById('aiImageInput');
            const file = aiImageInput.files[0];
            
            if (!file) {
                showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            // è·å–é€‰ä¸­çš„æ ‡ç­¾
            const selectedTags = {};
            Object.keys(tagCategories).forEach(category => {
                selectedTags[category] = [];
            });

            // è·å–æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾
            document.querySelectorAll('.tag-options').forEach(section => {
                const category = section.dataset.category;
                section.querySelectorAll('.tag-option.selected').forEach(tag => {
                    selectedTags[category].push(tag.textContent);
                });
            });

            try {
                // ä¿å­˜å›¾ç‰‡åˆ°çµæ„Ÿåº“
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        id: Date.now(),
                        url: e.target.result,
                        tags: selectedTags,
                        notes: document.getElementById('aiImageNotes')?.value || ''
                    };

                    // ä¿å­˜åˆ°æ•°æ®åº“
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(imageData);
                    
                    transaction.oncomplete = () => {
                        // å…³é—­AIæ¨¡æ€æ¡†
                        closeAIModal();
                        // åˆ·æ–°å›¾ç‰‡æ˜¾ç¤º
                        loadImages();
                        showToast('å›¾ç‰‡å’Œæ ‡ç­¾å·²ä¿å­˜');
                    };

                    transaction.onerror = (error) => {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    };
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ·»åŠ å¸¸ç”¨æ ‡ç­¾ç»„åˆåŠŸèƒ½
        function addTagCombination() {
            const commonCombinations = {
                'æ£®ç³»å®¢æˆ¿': ['æ£®ç³»', 'æ ‡å‡†å®¢æˆ¿', 'åŸæœ¨', 'ç»¿æ¤'],
                'æµ·æ™¯é¤å…': ['æµ·ç³»', 'é¤å…', 'è½åœ°çª—', 'è“è‰²ç³»'],
                'ç¦…æ„èŒ¶å®¤': ['ç¦…æ„', 'èŒ¶å®¤', 'æ¦»æ¦»ç±³', 'æœ¨è´¨']
            };
            
            // å®ç°å¿«é€Ÿæ·»åŠ æ ‡ç­¾ç»„åˆçš„åŠŸèƒ½
        }

        // åŸºäºå·²æœ‰æ ‡ç­¾çš„æ™ºèƒ½æ¨è
        function suggestRelatedTags(selectedTags) {
            const relatedTags = {
                'æ£®ç³»': ['åŸæœ¨', 'ç»¿æ¤', 'è‡ªç„¶å…‰'],
                'æµ·ç³»': ['è“è‰²ç³»', 'è½åœ°çª—', 'ç™½è‰²'],
                'ç¦…æ„': ['æœ¨è´¨', 'æ¦»æ¦»ç±³', 'ç®€çº¦']
            };
            
            // å®ç°ç›¸å…³æ ‡ç­¾æ¨èé€»è¾‘
        }

        // æ·»åŠ åœºæ™¯åŒ–æœç´¢åŠŸèƒ½
        function sceneBasedSearch(scene) {
            const sceneKeywords = {
                'æ—©é¤æ—¶å…‰': ['é¤å…', 'è‡ªç„¶å…‰', 'æ¸©é¦¨'],
                'ä¸‹åˆèŒ¶': ['ä¼‘æ¯åŒº', 'èˆ’é€‚', 'æƒ…ä¾£'],
                'å¤œï¿½ï¿½æ´¾å¯¹': ['é…’å§', 'ç¯å…‰', 'ç¤¾äº¤']
            };
            
            // å®ç°åœºæ™¯åŒ–æœç´¢é€»è¾‘
        }

        // åœ¨scriptæ ‡ç­¾å†…æ·»åŠ æ ‡ç­¾æ•°æ®æ„
        const tagCategories = {
            // ç©ºé—´åŠŸèƒ½
            function: {
                title: 'ç©ºé—´åŠŸèƒ½',
                tags: {
                    public: ['å¤§å ‚æ¥å¾…', 'ä¼‘æ¯åŒº', 'é¤å…', 'èŒ¶å®¤', 'é…’å§', 'å…¬å…±å¨æˆ¿', 'é˜…è¯»åŒº', 'å¥èº«åŒº', 'ç‘œä¼½å®¤', 'æ¸¸æˆå®¤', 'Co-working'],
                    room: ['æ ‡å‡†å®¢æˆ¿', 'å¥—æˆ¿', 'å®¶åº­æˆ¿', 'LOFT', 'å¤å¼æˆ¿', 'ä¸»å§', 'æ¬¡å§', 'å«ç”Ÿé—´', 'é˜³å°', 'éœ²å°'],
                    outdoor: ['åº­é™¢', 'æ³³æ± ', 'éœ²å°', 'é˜³å°', 'å±‹é¡¶èŠ±å›­', 'æˆ·å¤–é¤åŒº', 'æˆ·å¤–ä¼‘æ¯åŒº', 'æ™¯è§‚å°å“']
                }
            },
            // ç©ºé—´æ°›å›´
            atmosphere: {
                title: 'ç©ºé—´æ°›å›´',
                tags: {
                    nature: ['æ£®ç³»', 'æµ·ç³»', 'å±±ç³»', 'ç”°å›­ç³»'],
                    culture: ['ç¦…æ„', 'èŒ¶æ„', 'è‰ºæœ¯', 'å¤å¤'],
                    emotion: ['è½»æ¾', 'é™è°§', 'æ¸©é¦¨', 'æµªæ¼«', 'æ´»åŠ›'],
                    time: ['æ™¨å…‰', 'æ—¥å…‰', 'é»„æ˜', 'å¤œæ™š']
                }
            },
            // è®¾è®¡å…ƒç´ 
            elements: {
                title: 'è®¾è®¡å…ƒç´ ',
                tags: {
                    architecture: ['è½åœ°çª—', 'å¤©çª—', 'æ‹±é—¨', 'å»Šæ¶', 'åŠé¡¶', 'æ¥¼æ¢¯', 'å£ç‚‰', 'å†…å¤©äº•', 'æ¶ç©ºå±‚'],
                    softDecoration: ['çª—å¸˜', 'åœ°æ¯¯', 'æŠ±æ•', 'åºŠå“', 'è‰ºæœ¯å“', 'ç»¿æ¤', 'ç¯å…·', 'å®¶å…·', 'è£…é¥°å“'],
                    visualElements: ['å¯¹ç§°', 'é‡å¤', 'æ¸å˜', 'å±‚æ¬¡', 'å¯¹æ¯”', 'éŸµå¾‹', 'å¹³è¡¡', 'ç„¦ç‚¹']
                }
            },
            // åœºæ™¯æ•…äº‹
            story: {
                title: 'åœºæ™¯æ•…äº‹',
                tags: {
                    activity: ['æ—©é¤æ—¶å…‰', 'ä¸‹åˆèŒ¶', 'éœ²è¥', 'æ´¾å¯¹', 'ç‘œä¼½å†¥æƒ³', 'å·¥ä½œ', 'é˜…è¯»'],
                    nature: ['æµ·æ™¯ç¬¬ä¸€æ’', 'å±±æ™¯ç¬¬ä¸€æ’', 'æ£®æ—ç¯ç»•', 'ç”°å›­é£å…‰', 'åŸå¸‚å¤©é™…çº¿'],
                    special: ['äº²å­äº’åŠ¨', 'æƒ…ä¾£çº¦ä¼š', 'ç‹¬å¤„ç©ºé—´', 'ç¤¾äº¤ç©ºé—´', 'åˆ›ä½œç©ºé—´']
                }
            }
        };

        // ç”Ÿæˆæ ‡ç­¾æ˜¾ç¤ºåŒºåŸŸ
        function generateTags(category) {
            const categoryData = tagCategories[category];
            let html = `<button class="tag" data-category="${category}" data-tag="å…¨éƒ¨">å…¨éƒ¨</button>`;
            
            Object.values(categoryData.tags).forEach(tagGroup => {
                tagGroup.forEach(tag => {
                    html += `<button class="tag" data-category="${category}" data-tag="${tag}">${tag}</button>`;
                });
            });
            
            return html;
        }

        // ä¿®æ”¹ç°æœ‰çš„æ ‡ç­¾åŒºåŸŸHTML
        function updateTagSections() {
            const container = document.querySelector('.container');
            const waterfall = document.querySelector('.waterfall-container');
            
            const tagTips = {
                function: 'æ ¹æ®ç©ºé—´çš„ä½¿ç”¨åŠŸèƒ½è¿›è¡Œåˆ†ç±»ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šç”¨é€”çš„è®¾è®¡å‚è€ƒ',
                atmosphere: 'æè¿°ç©ºé—´çš„æ•´ä½“æ°›å›´å’Œé£æ ¼æ„Ÿå—ï¼Œå¸®åŠ©æ‚¨æ‰¾åˆ°ç¬¦åˆé¢„æœŸæƒ…ç»ªçš„è®¾è®¡çµæ„Ÿ',
                elements: 'æ ‡è®°è®¾è®¡ä¸­çš„å…³é”®å…ƒç´ å’Œç»†èŠ‚ï¼Œæ–¹ä¾¿æ‚¨å…³æ³¨ç‰¹å®šè®¾è®¡ç‰¹å¾',
                story: 'è®°å½•ç©ºé—´å¯èƒ½æ‰¿è½½çš„æ´»åŠ¨åœºæ™¯ï¼Œå¸®åŠ©æ‚¨æ€è€ƒç©ºé—´çš„å®é™…ä½¿ç”¨åœºæ™¯'
            };
            
            Object.entries(tagCategories).forEach(([category, data]) => {
                const section = document.createElement('div');
                section.className = 'tag-section';
                section.innerHTML = `
                    <div class="tag-title-wrapper">
                        <h3 class="tag-title">${data.title}</h3>
                        <span class="tag-help" data-tip="${tagTips[category]}">â“˜</span>
                    </div>
                    <div class="tags" data-category="${category}">
                        ${generateTags(category)}
                    </div>
                `;
                container.insertBefore(section, waterfall);
            });
        }

        // ä¿®æ”¹æ ‡ç­¾ç¼–è¾‘æ¨¡æ€æ¡†å†…å®¹
        function updateEditModal() {
            const editContent = document.querySelector('.edit-content .tag-categories');
            let html = '';
            
            Object.entries(tagCategories).forEach(([category, data]) => {
                html += `
                    <div class="tag-category">
                        <h4>${data.title}</h4>
                        <div class="tag-options" data-category="${category}">
                            ${Object.values(data.tags).flat().map(tag => 
                                `<button class="tag-option">${tag}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            
            editContent.innerHTML = html;
        }

        // åˆå§‹åŒ–æ—¶è°ƒç”¨
        document.addEventListener('DOMContentLoaded', () => {
            updateTagSections();
            updateEditModal();
            
            // åˆå§‹åŒ–æ•°æ®åº“
            const request = indexedDB.open(DB_NAME, 1);
            
            request.onerror = (event) => {
                console.error("æ•°æ®åº“é”™è¯¯:", event.target.error);
                showToast("æ•°æ®åº“é”™è¯¯ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®");
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                
                // ä¸ºæ‰€æœ‰æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        const category = tag.parentElement.dataset.category;
                        const isAll = tag.textContent === 'å…¨éƒ¨';
                        const tags = tag.parentElement.querySelectorAll('.tag');
                        
                        if (isAll) {
                            tags.forEach(t => t.classList.remove('selected'));
                            tag.classList.toggle('selected');
                        } else {
                            tag.parentElement.querySelector('.tag:first-child').classList.remove('selected');
                            tag.classList.toggle('selected');
                        }
                        
                        filterImages();
                    });
                });

                // åŠ è½½å·²æœ‰å›¾ç‰‡
                loadImages();
            };
        });

        // æ·»åŠ ç¡®è®¤åˆ é™¤æ‰€æœ‰ç…§ç‰‡çš„å‡½æ•°
        function confirmDeleteAll() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                deleteAllPhotos();
            }
        }

        // åˆ é™¤æ‰€æœ‰ç…§ç‰‡çš„å‡½æ•°
        function deleteAllPhotos() {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.clear();

            request.onsuccess = () => {
                loadImages(); // åˆ·æ–°æ˜¾ç¤º
                showToast('æ‰€æœ‰ç…§ç‰‡å·²åˆ é™¤');
            };

            request.onerror = (error) => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
        }

        // æ·»åŠ é€šç”¨çš„å…³é—­æ¨¡æ€æ¡†æ–¹æ³•
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('imageViewModal');
                closeModal('tagEditModal');
                closeAIModal();
            }
        });

        // æ·»åŠ æ ‡ç­¾è¯¦ç»†è¯´æ˜
        const tagDescriptions = {
            // ç©ºé—´åŠŸèƒ½æ ‡ç­¾è¯´æ˜
            function: {
                'å¤§å ‚æ¥å¾…': 'é…’åº—æˆ–å•†ä¸šç©ºé—´çš„ä¸»è¦å…¥å£åŒºåŸŸï¼Œä½“ç°æ¥å¾…å’ŒæœåŠ¡åŠŸèƒ½',
                'ä¼‘æ¯åŒº': 'ä¾›äººä¼‘æ†©æ”¾æ¾çš„å¼€æ”¾å¼ç©ºé—´ï¼Œé€šå¸¸é…å¤‡èˆ’é€‚çš„åº§æ¤…',
                'é¤å…': 'æä¾›ç”¨é¤æœåŠ¡çš„åŒºåŸŸï¼ŒåŒ…æ‹¬å°±é¤ç©ºé—´å’ŒæœåŠ¡ç©ºé—´',
                'èŒ¶å®¤': 'ä¸“é—¨ç”¨äºå“èŒ¶ã€å†¥æƒ³çš„é™è°§ç©ºé—´ï¼Œå¼ºè°ƒä¸œæ–¹ç¾å­¦',
                'é…’å§': 'ä»¥é…’æ°´æœåŠ¡ä¸ºä¸»çš„ç¤¾äº¤ç©ºé—´ï¼Œæ³¨é‡æ°›å›´è¥é€ ',
                'å…¬å…±å¨æˆ¿': 'å…±äº«å¼å¨æˆ¿ç©ºé—´ï¼Œé€‚åˆç¤¾äº¤äº’åŠ¨å’Œçƒ¹é¥ªä½“éªŒ',
                'é˜…è¯»åŒº': 'å®‰é™çš„é˜…è¯»å’Œå­¦ä¹ ç©ºé—´ï¼Œæ³¨é‡ç…§æ˜å’Œèˆ’é€‚åº¦',
                'å¥ï¿½ï¿½ï¿½åŒº': 'è¿åŠ¨å¥èº«åœºæ‰€ï¼Œéœ€è¦åˆç†çš„ç©ºé—´å¸ƒå±€å’Œè®¾å¤‡é…ç½®',
                'ç‘œä¼½å®¤': 'ç”¨äºç‘œä¼½ã€å†¥æƒ³çš„ä¸“å±ç©ºé—´ï¼Œå¼ºè°ƒå®é™å’Œæ”¾æ¾',
                'æ¸¸æˆå®¤': 'å¨±ä¹äº’åŠ¨ç©ºé—´ï¼Œé€‚åˆç¤¾äº¤æ´»åŠ¨å’Œä¼‘é—²å¨±ä¹',
                'Co-working': 'å…±äº«åŠå…¬ç©ºé—´ï¼Œå…¼å…·åŠå…¬å’Œç¤¾äº¤åŠŸèƒ½',
                'æ ‡å‡†å®¢æˆ¿': 'é…’åº—åŸºç¡€ä½å®¿å•å…ƒï¼Œæä¾›èˆ’é€‚çš„ä¼‘æ¯ç©ºé—´',
                'å¥—æˆ¿': 'å¸¦æœ‰ç‹¬ç«‹èµ·å±…å®¤çš„è±ªåä½å®¿ç©ºé—´',
                'å®¶åº­æˆ¿': 'é€‚åˆå®¶åº­å…¥ä½çš„å¤§å‹æˆ¿é—´ï¼Œé…å¤‡å®Œå–„è®¾æ–½',
                'LOFT': 'æŒ‘é«˜ç©ºé—´è®¾è®¡ï¼Œå…·æœ‰ç°ä»£è‰ºæœ¯æ„Ÿ',
                'å¤å¼æˆ¿': 'åŒå±‚ç»“æ„ä½å®¿ç©ºé—´ï¼Œç©ºé—´åˆ©ç”¨æ›´çµæ´»',
                'ä¸»å§': 'ä½å®…ä¸­çš„ä¸»è¦ç¡çœ ç©ºé—´ï¼Œæ³¨é‡ç§å¯†æ€§å’Œèˆ’é€‚åº¦',
                'æ¬¡å§': 'æ¬¡è¦å§å®¤ç©ºé—´ï¼Œå¯çµæ´»æ”¹é€ ä½¿ç”¨',
                'å«ç”Ÿé—´': 'ç›¥æ´—ç©ºé—´ï¼Œæ³¨é‡åŠŸèƒ½æ€§å’Œå«ç”Ÿæ¡ä»¶',
                'é˜³å°': 'å®¤å†…å¤–è¿‡æ¸¡ç©ºé—´ï¼Œæä¾›è‡ªç„¶é‡‡å…‰å’Œä¼‘é—²åŒºåŸŸ',
                'éœ²å°': 'å¼€æ”¾å¼å®¤å¤–æ´»åŠ¨ç©ºé—´ï¼Œå¯ç”¨äºä¼‘é—²å¨±ä¹',
                'åº­é™¢': 'ç§å¯†çš„æˆ·å¤–ç»¿åŒ–ç©ºé—´ï¼Œæä¾›è‡ªç„¶ç¯å¢ƒä½“éªŒ',
                'æ³³æ± ': 'ä¾›æ¸¸æ³³è¿åŠ¨å’Œä¼‘é—²çš„æ°´æ™¯è®¾æ–½',
                'å±‹é¡¶èŠ±å›­': 'æ¥¼é¡¶ç»¿åŒ–ç©ºé—´ï¼Œæä¾›ä¼‘é—²å’Œè§‚æ™¯åŠŸèƒ½',
                'æˆ·å¤–é¤åŒº': 'å®¤å¤–ç”¨é¤ç©ºé—´ï¼Œç»“åˆè‡ªç„¶ç¯å¢ƒ',
                'æˆ·å¤–ä¼‘æ¯åŒº': 'æˆ·å¤–æ”¾æ¾ä¼‘æ†©çš„å¼€æ”¾ç©ºé—´',
                'æ™¯è§‚å°å“': 'è£…é¥°æ€§æ™¯è§‚å…ƒç´ ï¼Œæå‡ç¯å¢ƒç¾æ„Ÿ',
                'å¥èº«åŒº': 'è¿åŠ¨å¥èº«åœºæ‰€ï¼Œéœ€è¦åˆç†çš„ç©ºé—´å¸ƒå±€å’Œè®¾å¤‡é…ç½®'
            },
            // ç©ºé—´æ°›å›´æ ‡ç­¾è¯´æ˜
            atmosphere: {
                'æ£®ç³»': 'ä»¥è‡ªç„¶å…ƒç´ ä¸ºä¸»ï¼Œè¥é€ æ¸…æ–°è‡ªç„¶çš„æ°›å›´',
                'æµ·ç³»': 'è¿ç”¨è“è‰²è°ƒå’Œæµ·æ´‹å…ƒç´ ï¼Œæ‰“é€ æ¸…çˆ½èˆ’é€‚çš„ç©ºé—´æ„Ÿ',
                'å±±ç³»': 'èå…¥å±±æ™¯å…ƒç´ ï¼Œä½“ç°è‡ªç„¶ä¸äººæ–‡çš„å’Œè°',
                'ç”°å›­ç³»': 'ç»“åˆä¹¡æ‘é£æƒ…ï¼Œè¥é€ æ¸©é¦¨è‡ªç„¶çš„æ°›å›´',
                'ç¦…æ„': 'ç®€çº¦æ·¡é›…ï¼Œä½“ç°ä¸œæ–¹ç¦…å­¦ç¾å­¦',
                'èŒ¶æ„': 'èå…¥èŒ¶æ–‡åŒ–å…ƒç´ ï¼Œè¥é€ é›…è‡´æ¬é™çš„æ°›å›´',
                'è‰ºæœ¯': 'èå…¥è‰ºæœ¯ä½œå“ï¼Œå½°æ˜¾æ–‡åŒ–å“å‘³',
                'å¤å¤': 'è¿ç”¨æ€€æ—§å…ƒç´ ï¼Œé‡ç°ç‰¹å®šå¹´ä»£é£æ ¼',
                'è½»æ¾': 'èˆ’é€‚æƒ¬æ„çš„æ°›å›´ï¼Œå‡å°‘å‹åŠ›æ„Ÿçš„ç©ºé—´è®¾è®¡',
                'é™è°§': 'å®‰é™ç¥¥å’Œçš„æ°›å›´ï¼Œé€‚åˆæ”¾æ¾å’Œæ²‰æ€',
                'æ¸©é¦¨': 'ç»™äººæ¸©æš–èˆ’é€‚æ„Ÿçš„ç©ºé—´æ°›å›´ï¼Œåƒå®¶ä¸€æ ·èˆ’é€‚',
                'æµªæ¼«': 'è¥é€ æ¸©æƒ…æµªæ¼«çš„æ°›å›´ï¼Œé€‚åˆæƒ…ä¾£æˆ–ç‰¹æ®Šåœºåˆ',
                'æ´»åŠ›': 'å……æ»¡æœæ°”å’Œæ´»åŠ›çš„ç©ºé—´æ°›å›´ï¼Œè®©äººç²¾ç¥ç„•å‘',
                'æ™¨å…‰': 'æ¸…æ™¨é˜³å…‰è¥é€ çš„æ˜äº®æ¸©æš–æ°›å›´',
                'æ—¥å…‰': 'å……è¶³è‡ªç„¶å…‰ç…§å°„ä¸‹çš„æ˜å¿«ç©ºé—´æ°›å›´',
                'é»„æ˜': 'æ—¥è½æ—¶åˆ†æ¸©æš–æŸ”å’Œçš„å…‰çº¿æ°›å›´',
                'å¤œæ™š': 'å¤œé—´ç¯å…‰è¥é€ çš„æ¸©é¦¨é™è°§æ°›å›´'
            },
            // è®¾è®¡å…ƒç´ æ ‡ç­¾è¯´æ˜
            elements: {
                'è½åœ°çª—': 'å¤§é¢ç§¯ç»ç’ƒçª—ï¼Œæä¾›è‡ªç„¶é‡‡å…‰å’Œæ™¯è§‚è§†é‡',
                'å¤©çª—': 'å±‹é¡¶é‡‡å…‰çª—ï¼Œå¼•å…¥è‡ªç„¶å…‰çº¿å’Œç©ºé—´å˜åŒ–',
                'æ‹±é—¨': 'å¼§å½¢é—¨æ´è®¾è®¡ï¼Œå¢æ·»ç©ºé—´å±‚æ¬¡å’Œè‰ºæœ¯æ„Ÿ',
                'å»Šæ¶': 'æ¶ç©ºç»“æ„ï¼Œç”¨äºç©ºé—´åˆ†éš”æˆ–æ™¯è§‚è¥é€ ',
                'åŠé¡¶': 'å¤©èŠ±æ¿é€ å‹è®¾è®¡ï¼Œå¼ºè°ƒç©ºé—´ä¸»é¢˜',
                'æ¥¼æ¢¯': 'å‚ç›´äº¤é€šç©ºé—´ï¼Œå…¼å…·å®ç”¨æ€§å’Œè£…é¥°æ€§',
                'å£ç‚‰': 'ä¾›å–æš–æˆ–è£…é¥°ç”¨çš„ç«ç‚‰è®¾è®¡',
                'å†…å¤©äº•': 'å®¤å†…åº­é™¢ç©ºé—´ï¼Œæä¾›é‡‡å…‰å’Œè‡ªç„¶æ™¯è§‚',
                'çª—å¸˜': 'ç”¨äºæ§åˆ¶å…‰çº¿å’Œéšç§çš„çª—å¸˜',
                'åœ°æ¯¯': 'è£…é¥°æ€§åœ°æ¯¯ï¼Œå¢æ·»ç©ºé—´æ¸©é¦¨æ„Ÿ',
                'æŠ±æ•': 'è£…é¥°æ€§æŠ±æ•ï¼Œæä¾›èˆ’é€‚çš„ä¼‘æ†©æ„Ÿ',
                'åºŠå“': 'è£…é¥°æ€§åºŠå“ï¼Œå¢æ·»ç©ºé—´èˆ’é€‚åº¦',
                'è‰ºæœ¯å“': 'è£…é¥°æ€§è‰ºæœ¯å“ï¼Œå½°æ˜¾æ–‡åŒ–å“å‘³',
                'ç»¿æ¤': 'å®¤å†…ç»¿æ¤ï¼Œæä¾›è‡ªç„¶ç¯å¢ƒå’Œç©ºæ°”å‡€åŒ–',
                'å®¶å…·': 'è£…é¥°æ€§å®¶å…·ï¼Œå¢æ·»ç©ºé—´å®ç”¨æ€§å’Œç¾è§‚',
                'è£…é¥°å“': 'è£…é¥°æ€§è£…é¥°å“ï¼Œå¢æ·»ç©ºé—´è‰ºæœ¯æ„Ÿ',
                'å¯¹ç§°': 'å¯¹ç§°å¸ƒå±€ï¼Œå¢æ·»ç©ºé—´ç¾è§‚å’Œå¹³è¡¡æ„Ÿ',
                'é‡å¤': 'é‡å¤å…ƒç´ ï¼Œå¢æ·»ç©ºé—´èŠ‚å¥æ„Ÿ',
                'æ¸å˜': 'æ¸å˜è‰²å½©ï¼Œå¢æ·»ç©ºé—´å±‚æ¬¡æ„Ÿ',
                'å±‚æ¬¡': 'å±‚æ¬¡å¸ƒå±€ï¼Œå¢æ·»ç©ºé—´æ·±åº¦æ„Ÿ',
                'å¯¹æ¯”': 'å¯¹æ¯”è‰²å½©ï¼Œå¢æ·»ç©ºé—´è§†è§‰å†²å‡»åŠ›',
                'éŸµå¾‹': 'éŸµå¾‹å¸ƒå±€ï¼Œå¢æ·»ç©ºé—´èŠ‚å¥æ„Ÿ',
                'å¹³è¡¡': 'å¹³è¡¡å¸ƒå±€ï¼Œå¢æ·»ç©ºé—´å’Œè°æ„Ÿ',
                'ç„¦ç‚¹': 'ç„¦ç‚¹å…ƒç´ ï¼Œå¸å¼•è§†çº¿å’Œæ³¨æ„åŠ›',
                'æ¶ç©ºå±‚': 'å»ºç­‘ä¸­çš„æ¶ç©ºè®¾è®¡ï¼Œæä¾›é€šé£å’Œç©ºé—´å»¶å±•',
                'ç¯å…·': 'ç…§æ˜è®¾å¤‡çš„è‰ºæœ¯è®¾è®¡ï¼Œæ—¢å®ç”¨åˆè£…é¥°'
            },
            // åœºæ™¯æ•…äº‹æ ‡ç­¾è¯´æ˜
            story: {
                'æ—©é¤æ—¶å…‰': 'æ¸…æ™¨ç”¨é¤åœºæ™¯ï¼Œå¼ºè°ƒæ˜äº®æ¸©é¦¨çš„æ°›å›´',
                'ä¸‹åˆèŒ¶': 'ä¼‘é—²ç¤¾äº¤åœºæ™¯ï¼Œæ³¨é‡èˆ’é€‚å’Œä¼˜é›…',
                'éœ²è¥': 'æˆ·å¤–éœ²è¥ä½“éªŒç©ºé—´ï¼Œèåˆè‡ªç„¶å…ƒç´ ',
                'æ´¾å¯¹': 'ç¤¾äº¤èšä¼šåœºæ™¯ï¼Œå¼ºè°ƒäº’åŠ¨å’Œæ°›å›´',
                'ç‘œä¼½å†¥æƒ³': 'é™å¿ƒä¿®ä¹ åœºæ™¯ï¼Œæ³¨é‡ç©ºé—´çš„å®é™æ„Ÿ',
                'å·¥ä½œ': 'åŠå…¬åœºæ™¯ï¼Œå¹³è¡¡æ•ˆç‡ä¸èˆ’é€‚åº¦',
                'é˜…è¯»': 'å®‰é™é˜…è¯»åœºæ™¯ï¼Œè¥é€ ä¸“æ³¨çš„æ°›å›´',
                'æµ·æ™¯ç¬¬ä¸€æ’': 'ç›´é¢æµ·æ™¯çš„ä¼˜è´¨è§‚æ™¯ä½ç½®ï¼Œå°½äº«æµ·å¤©ä¸€è‰²',
                'å±±æ™¯ç¬¬ä¸€æ’': 'é¢å‘å±±æ™¯çš„ç»ä½³ä½ç½®ï¼Œæ¬£èµè‡ªç„¶ç¾æ™¯',
                'æ£®æ—ç¯ç»•': 'è¢«ç»¿è‰²æ¤è¢«ç¯æŠ±çš„ç©ºé—´ï¼Œäº«å—è‡ªç„¶æ°›å›´',
                'ç”°å›­é£å…‰': 'å……æ»¡ä¹¡æ‘ç”°å›­æ°”æ¯çš„æ™¯è§‚ç¯å¢ƒ',
                'åŸå¸‚å¤©é™…çº¿': 'å¯è§‚èµåŸå¸‚å¤©é™…çº¿çš„ä¼˜è¶Šä½ç½®',
                'äº²å­äº’åŠ¨': 'é€‚åˆçˆ¶æ¯ä¸å­©å­äº’åŠ¨çš„æ¸©é¦¨åœºæ™¯',
                'æƒ…ä¾£çº¦ä¼š': 'é€‚åˆæƒ…ä¾£å…±å¤„çš„æµªæ¼«åœºæ™¯è®¾è®¡',
                'ç‹¬å¤„ç©ºé—´': 'é€‚åˆä¸€ä¸ªäººå®‰é™æ”¾æ¾çš„ç§å¯†ç©ºé—´',
                'ç¤¾äº¤ç©ºé—´': 'é€‚åˆäººä»¬äº¤æµäº’åŠ¨çš„å¼€æ”¾å¼ç©ºé—´',
                'åˆ›ä½œç©ºé—´': 'æ¿€å‘åˆ›æ„çµæ„Ÿçš„ä¸“ä¸šå·¥ä½œç©ºé—´'
            }
        };

        /* æ·»åŠ æç¤ºæ¡†æ˜¾ç¤ºé€»è¾‘ */
        function showTooltip(event, text) {
            if (!text) return; // å¦‚æœæ²¡æœ‰æè¿°æ–‡æœ¬ï¼Œä¸æ˜¾ç¤ºæç¤ºæ¡†
            let tooltip = document.querySelector('.tooltip-container');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'tooltip-container';
                document.body.appendChild(tooltip);
            }

            tooltip.textContent = text;
            tooltip.style.display = 'block';

            const rect = event.target.getBoundingClientRect();
            const tooltipHeight = tooltip.offsetHeight;

            // è®¡ç®—è§†å£è¾¹ç•Œ
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;

            // è®¡ç®—åŸºç¡€ä½ç½®
            let left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
            let top = rect.top - tooltipHeight - 10;

            // ç¡®ä¿æç¤ºæ¡†ä¸ä¼šè¶…å‡ºè§†å£è¾¹ç•Œ
            if (top < 0) {
                // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹
                top = rect.bottom + 10;
            }
            if (left < 0) {
                left = 0;
            } else if (left + tooltip.offsetWidth > viewportWidth) {
                left = viewportWidth - tooltip.offsetWidth;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        /* æ·»åŠ æç¤ºæ¡†éšè—é€»è¾‘ */
        document.addEventListener('mouseover', function(event) {
            const tag = event.target;
            if (tag.classList.contains('tag')) {
                const category = tag.dataset.category;
                const tagText = tag.dataset.tag;
                
                let tooltipText = '';
                if (tagText === 'å…¨éƒ¨') {
                    tooltipText = `æ˜¾ç¤ºæ‰€æœ‰${tagCategories[category].title}`;
                } else {
                    tooltipText = tagDescriptions[category]?.[tagText];
                }
                
                if (tooltipText) {
                    showTooltip(event, tooltipText);
                }
            }
        });

        document.addEventListener('mouseout', function(event) {
            if (event.target.classList.contains('tag')) {
                const tooltip = document.querySelector('.tooltip-container');
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
    
